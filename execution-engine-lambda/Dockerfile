FROM public.ecr.aws/lambda/python:3.11
RUN pip install poetry

COPY handler.py ${LAMBDA_TASK_ROOT}
COPY pyproject.toml ${LAMBDA_TASK_ROOT}
COPY README.md ${LAMBDA_TASK_ROOT}

ARG STATE_MACHINE_ARN_BUILD
ARG DEPLOY_ENVIRONMENT
ARG AWS_DEFAULT_REGION
ARG AWS_ACCOUNT_ID
ARG CODEARTIFACT_AUTH_TOKEN
ARG PRELOOP_API_ENDPOINT

ENV STATE_MACHINE_ARN=${STATE_MACHINE_ARN_BUILD}
ENV DEPLOY_ENVIRONMENT=${DEPLOY_ENVIRONMENT}
ENV AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
ENV AWS_ACCOUNT_ID=${AWS_ACCOUNT_ID}
ENV PRELOOP_API_ENDPOINT=${PRELOOP_API_ENDPOINT}

RUN poetry config virtualenvs.create false && \
poetry install --no-root

CMD ["handler.lambda_handler"]
