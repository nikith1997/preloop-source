FROM python:3.11
RUN apt-get update && apt-get upgrade -y && apt-get install -y curl software-properties-common
RUN pip install poetry
RUN pip --no-cache-dir install --upgrade awscli

ARG DATABASE_URL
ARG DATABASE_URL_ASYNC
ARG PRELOOP_DATASTORE_URL
ARG CODEARTIFACT_AUTH_TOKEN
ARG DEPLOY_ENVIRONMENT
ARG AWS_DEFAULT_REGION
ARG AWS_ACCOUNT_ID
ARG PRELOOP_API_KEY_INTERNAL_SECRET_ENCRYPTION_KEY
ARG COMPUTE_SUBNET_1
ARG COMPUTE_SUBNET_2
ARG PUBLIC_SUBNET_1
ARG PUBLIC_SUBNET_2
ARG MODEL_ENDPOINT_LOAD_BALANCER_SECURITY_GROUP
ARG MODEL_ENDPOINT_LOAD_BALANCER_CERTIFICATE_ARN=DUMMY
ARG MODEL_ENDPOINT_ROUTE_53_HOSTED_ZONE_ID=DUMMY
ARG VPC_ID
ARG PRELOOP_USER_SCRIPT_ENV_VARS_ENCRYPTION_KEY

ENV DATABASE_URL=${DATABASE_URL}
ENV DATABASE_URL_ASYNC=${DATABASE_URL_ASYNC}
ENV PRELOOP_DATASTORE_URL=${PRELOOP_DATASTORE_URL}
ENV CODEARTIFACT_AUTH_TOKEN=${CODEARTIFACT_AUTH_TOKEN}
ENV DEPLOY_ENVIRONMENT=${DEPLOY_ENVIRONMENT}
ENV AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
ENV AWS_ACCOUNT_ID=${AWS_ACCOUNT_ID}
ENV PRELOOP_API_KEY_INTERNAL_SECRET_ENCRYPTION_KEY=${PRELOOP_API_KEY_INTERNAL_SECRET_ENCRYPTION_KEY}
ENV COMPUTE_SUBNET_1=${COMPUTE_SUBNET_1}
ENV COMPUTE_SUBNET_2=${COMPUTE_SUBNET_2}
ENV PUBLIC_SUBNET_1=${PUBLIC_SUBNET_1}
ENV PUBLIC_SUBNET_2=${PUBLIC_SUBNET_2}
ENV MODEL_ENDPOINT_LOAD_BALANCER_SECURITY_GROUP=${MODEL_ENDPOINT_LOAD_BALANCER_SECURITY_GROUP}
ENV MODEL_ENDPOINT_LOAD_BALANCER_CERTIFICATE_ARN=${MODEL_ENDPOINT_LOAD_BALANCER_CERTIFICATE_ARN}
ENV MODEL_ENDPOINT_ROUTE_53_HOSTED_ZONE_ID=${MODEL_ENDPOINT_ROUTE_53_HOSTED_ZONE_ID}
ENV VPC_ID=${VPC_ID}
ENV PRELOOP_USER_SCRIPT_ENV_VARS_ENCRYPTION_KEY=${PRELOOP_USER_SCRIPT_ENV_VARS_ENCRYPTION_KEY}

WORKDIR /app
COPY pyproject.toml Makefile ./
COPY src/ /app/src/

RUN export CODEARTIFACT_DOMAIN_NAME=preloop-artifactory-${DEPLOY_ENVIRONMENT} && \
export PRELOOP_PRIVATE_REPO=preloop_main && \
export PYPI_REPO=pypi-store && \
export CODEARTIFACT_USER=aws && \
poetry source remove ${PRELOOP_PRIVATE_REPO} && \
poetry source remove ${PYPI_REPO} && \
poetry source add --priority=default ${PRELOOP_PRIVATE_REPO} https://preloop-artifactory-${DEPLOY_ENVIRONMENT}-${AWS_ACCOUNT_ID}.d.codeartifact.${AWS_DEFAULT_REGION}.amazonaws.com/pypi/${PRELOOP_PRIVATE_REPO}/simple/ && \
poetry source add --priority=supplemental ${PYPI_REPO} https://preloop-artifactory-${DEPLOY_ENVIRONMENT}-${AWS_ACCOUNT_ID}.d.codeartifact.${AWS_DEFAULT_REGION}.amazonaws.com/pypi/${PYPI_REPO}/simple/ && \
poetry config http-basic.${PRELOOP_PRIVATE_REPO} ${CODEARTIFACT_USER} ${CODEARTIFACT_AUTH_TOKEN} && \
poetry config http-basic.${PYPI_REPO} ${CODEARTIFACT_USER} ${CODEARTIFACT_AUTH_TOKEN} && \
poetry config virtualenvs.create false && \
poetry install --no-root

RUN cd src && export PYTHONPATH=$PWD && cd ..
CMD poetry run gunicorn src.main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:80 
